# üì¶ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è XML —ñ–º–ø–æ—Ä—Ç—É —Ç–æ–≤–∞—Ä—ñ–≤

## üéØ –û–≥–ª—è–¥

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —ñ–º–ø–æ—Ä—Ç—É —Ç–æ–≤–∞—Ä—ñ–≤ –∑ XML —Ñ—ñ–¥—É `https://mma.in.ua/feed/xml/iDxAyRECF.xml` –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏:

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —ñ–º–ø–æ—Ä—Ç** –∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏
- **Upsert –ª–æ–≥—ñ–∫–∞** (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–∏—Ö, –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö)
- **–í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö** –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
- **–õ–æ–≥—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤** –≤ –±–∞–∑—É –¥–∞–Ω–∏—Ö
- **–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å** –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è

## üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### 1. –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

–í–∏–∫–æ–Ω–∞–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç–∏ –≤ Supabase Dashboard:

```sql
-- 1. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ö–µ–º—É products
-- –í–∏–∫–æ–Ω–∞—Ç–∏ update-products-schema.sql

-- 2. –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –ª–æ–≥—ñ–≤
-- –í–∏–∫–æ–Ω–∞—Ç–∏ create-import-logs-table.sql
```

### 2. –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

–î–æ–¥–∞–π—Ç–µ –¥–æ `.env.local`:

```bash
# Cron —Å–µ–∫—Ä–µ—Ç –¥–ª—è –±–µ–∑–ø–µ–∫–∏
CRON_SECRET=your-secure-cron-secret

# –Ü—Å–Ω—É—é—á—ñ –∑–º—ñ–Ω–Ω—ñ (—è–∫—â–æ —â–µ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

### 3. Cron Job –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

#### –í–∞—Ä—ñ–∞–Ω—Ç A: Vercel Cron Jobs

–î–æ–¥–∞–π—Ç–µ –¥–æ `vercel.json`:

```json
{
  "crons": [
    {
      "path": "/api/cron/import-products",
      "schedule": "0 */2 * * *"
    }
  ]
}
```

#### –í–∞—Ä—ñ–∞–Ω—Ç B: External Cron Service

–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Å–µ—Ä–≤—ñ—Å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, cron-job.org):

- **URL**: `https://antiblackout.shop/api/cron/import-products`
- **Schedule**: `0 */2 * * *` (–∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏)
- **Headers**: `Authorization: Bearer your-secure-cron-secret`

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö

### XML ‚Üí Database Mapping

| XML Field | Database Column | Type | Notes |
|-----------|----------------|------|-------|
| `<code>` | `external_id` | TEXT | –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä |
| `<name>` | `name` | TEXT | –ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É |
| `<description>` | `description` | TEXT | –û–ø–∏—Å —Ç–æ–≤–∞—Ä—É |
| `<price>` | `price` | NUMERIC(10,2) | –¶—ñ–Ω–∞ –≤ UAH |
| `<brand>` | `brand` | TEXT | –ë—Ä–µ–Ω–¥ |
| `<category>` | `category` | TEXT | –ö–∞—Ç–µ–≥–æ—Ä—ñ—è |
| `<quantity_in_stock>` | `quantity` | INTEGER | –ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥—ñ |
| `<image>` | `image_url` | TEXT | URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è |
| - | `currency` | TEXT | –ñ–æ—Ä—Å—Ç–∫–æ "UAH" |
| - | `id` | UUID | –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ |
| - | `created_at` | TIMESTAMP | –ß–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è |
| - | `updated_at` | TIMESTAMP | –ß–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è |

### –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö

- **–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è**: `external_id`, `name`
- **–¶—ñ–Ω–∞**: `>= 0`, fallback –¥–æ 0
- **–ö—ñ–ª—å–∫—ñ—Å—Ç—å**: `>= 0`, fallback –¥–æ 0
- **–ù–∞–∑–≤–∞**: –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é
- **–í–∞–ª—é—Ç–∞**: –∑–∞–≤–∂–¥–∏ "UAH"

## üöÄ API Endpoints

### 1. –†—É—á–Ω–∏–π —ñ–º–ø–æ—Ä—Ç

```bash
POST /api/products/import
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "success": true,
  "message": "Products imported successfully",
  "stats": {
    "total": 150,
    "valid": 145,
    "invalid": 5,
    "imported": 20,
    "updated": 125,
    "errors": 0
  }
}
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É

```bash
GET /api/products/import
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "success": true,
  "stats": {
    "total": 150,
    "withExternalId": 145,
    "withPrice": 140,
    "inStock": 120,
    "withImages": 130
  }
}
```

### 3. –û—á–∏—Å—Ç–∫–∞ —Ñ–µ–π–∫–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤

```bash
POST /api/products/cleanup
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "success": true,
  "stats": {
    "total": 150,
    "deleted": 10,
    "kept": 140
  }
}
```

### 4. Cron —ñ–º–ø–æ—Ä—Ç

```bash
GET /api/cron/import-products
Authorization: Bearer your-secure-cron-secret
```

## üéõÔ∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å

### –î–æ—Å—Ç—É–ø: `/admin/products`

**–§—É–Ω–∫—Ü—ñ—ó:**
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–≤–∞—Ä—ñ–≤** - –∑–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
- **–†—É—á–Ω–∏–π —ñ–º–ø–æ—Ä—Ç** - –∑–∞–ø—É—Å–∫ —ñ–º–ø–æ—Ä—Ç—É –≤—Ä—É—á–Ω—É
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–µ–π–∫–æ–≤–∏—Ö** - –∞–Ω–∞–ª—ñ–∑ —Ñ–µ–π–∫–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
- **–û—á–∏—Å—Ç–∫–∞ —Ñ–µ–π–∫–æ–≤–∏—Ö** - –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–µ–π–∫–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
- **–õ–æ–≥–∏ —ñ–º–ø–æ—Ä—Ç—É** - —ñ—Å—Ç–æ—Ä—ñ—è —ñ–º–ø–æ—Ä—Ç—ñ–≤

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å—å–æ–≥–æ —Ç–æ–≤–∞—Ä—ñ–≤** - –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
- **–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏—Ö** - –∑ external_id
- **–ó —Ü—ñ–Ω–æ—é** - –∑ –≤–∞–ª—ñ–¥–Ω–æ—é —Ü—ñ–Ω–æ—é
- **–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ** - –∑ quantity > 0
- **–ó —Ñ–æ—Ç–æ** - –∑ image_url

## üîÑ –õ–æ–≥—ñ–∫–∞ —ñ–º–ø–æ—Ä—Ç—É

### 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è XML

```typescript
const products = await parseXMLFeed(XML_FEED_URL);
```

### 2. –í–∞–ª—ñ–¥–∞—Ü—ñ—è

```typescript
const { valid, invalid, stats } = validateProducts(products);
```

### 3. Upsert –≤ –±–∞–∑—É

```typescript
for (const product of valid) {
  const existing = await findProductByExternalId(product.external_id);
  
  if (existing) {
    await updateProduct(existing.id, product);
  } else {
    await createProduct(product);
  }
}
```

### 4. –õ–æ–≥—É–≤–∞–Ω–Ω—è

```typescript
await logImportResult({
  success: true,
  imported: 20,
  updated: 125,
  errors: 0,
  timestamp: new Date().toISOString()
});
```

## üõ°Ô∏è –ë–µ–∑–ø–µ–∫–∞

### 1. Cron Secret

- **–ó–º—ñ–Ω–Ω–∞**: `CRON_SECRET`
- **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**: `Authorization: Bearer {secret}`
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Å–∫–ª–∞–¥–Ω–∏–π –ø–∞—Ä–æ–ª—å

### 2. –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö

- **XML –ø–∞—Ä—Å–∏–Ω–≥** –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
- **–¢–∏–ø—ñ–∑–∞—Ü—ñ—è** –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤
- **Sanitization** –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- **Fallback –∑–Ω–∞—á–µ–Ω–Ω—è** –¥–ª—è –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –ø–æ–ª—ñ–≤

### 3. –û–±–º–µ–∂–µ–Ω–Ω—è

- **Rate limiting** –¥–ª—è API
- **Timeout** –¥–ª—è XML –∑–∞–ø–∏—Ç—ñ–≤
- **Retry –ª–æ–≥—ñ–∫–∞** –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö

## üìà –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

### 1. –õ–æ–≥–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

–¢–∞–±–ª–∏—Ü—è `import_logs` –º—ñ—Å—Ç–∏—Ç—å:
- **success** - —É—Å–ø—ñ—à–Ω—ñ—Å—Ç—å —ñ–º–ø–æ—Ä—Ç—É
- **imported** - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
- **updated** - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
- **errors** - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫
- **error_message** - —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏
- **created_at** - —á–∞—Å —ñ–º–ø–æ—Ä—Ç—É

### 2. –ö–æ–Ω—Å–æ–ª—å–Ω—ñ –ª–æ–≥–∏

```bash
# –£—Å–ø—ñ—à–Ω–∏–π —ñ–º–ø–æ—Ä—Ç
‚úÖ Import completed: 20 imported, 125 updated, 0 errors

# –ü–æ–º–∏–ª–∫–∞
‚ùå Error in scheduled import: XML parsing failed
```

### 3. Email —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É email –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö:

```typescript
if (importResult.errors > 0) {
  await sendErrorNotification(importResult);
}
```

## üîß –ù–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è

### 1. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è XML —Ñ—ñ–¥—É

```bash
curl "https://mma.in.ua/feed/xml/iDxAyRECF.xml" | head -20
```

### 2. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API

```bash
# –†—É—á–Ω–∏–π —ñ–º–ø–æ—Ä—Ç
curl -X POST "https://antiblackout.shop/api/products/import"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
curl "https://antiblackout.shop/api/products/import"
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤

```sql
SELECT * FROM import_logs 
ORDER BY created_at DESC 
LIMIT 10;
```

## üö® –í–∞–∂–ª–∏–≤–æ

1. **–í–∏–∫–æ–Ω–∞–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç–∏** –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º
2. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ CRON_SECRET** –¥–ª—è –±–µ–∑–ø–µ–∫–∏
3. **–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ —ñ–º–ø–æ—Ä—Ç** –≤—Ä—É—á–Ω—É –ø–µ—Ä–µ–¥ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º cron
4. **–ú–æ–Ω—ñ—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º
5. **–†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è** –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ—é —Ñ–µ–π–∫–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö:
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –≤ `import_logs` —Ç–∞–±–ª–∏—Ü—ñ
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å–Ω—ñ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
3. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ XML —Ñ—ñ–¥ –¥–æ—Å—Ç—É–ø–Ω–∏–π
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Supabase
5. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å CRON_SECRET
