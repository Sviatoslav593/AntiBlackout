# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ 500 –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–Ω–∏–∫–∞–ª–∞ –ø–æ–º–∏–ª–∫–∞:

```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
Failed to submit order: Error: Internal server error
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

1. **RLS (Row Level Security) –ø–æ–ª—ñ—Ç–∏–∫–∏** –±–ª–æ–∫—É–≤–∞–ª–∏ –≤—Å—Ç–∞–≤–∫—É –¥–∞–Ω–∏—Ö –≤ —Ç–∞–±–ª–∏—Ü—ñ
2. **–ù–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Ç–∏–ø—ñ–≤** - `product_id` –ø–µ—Ä–µ–¥–∞–≤–∞–≤—Å—è —è–∫ —á–∏—Å–ª–æ, –∞ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –æ—á—ñ–∫—É–≤–∞–≤—Å—è UUID
3. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ñ–≤** –≤ —Ç–∞–±–ª–∏—Ü—ñ `products` –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω—å

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### 1. –°–ø—Ä–æ—â–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö

- –í–∏–¥–∞–ª–µ–Ω–æ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤—ñ–¥ —Ç–∞–±–ª–∏—Ü—ñ `products` –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω—å
- `product_id` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —è–∫ `null` –≤ `order_items`
- –î–æ–¥–∞–Ω–æ `product_name` –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –Ω–∞–∑–≤–∏ —Ç–æ–≤–∞—Ä—É

### 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è API endpoint (`/api/order/route.ts`)

```typescript
items: orderData.items.map((item) => ({
  product_id: null, // Don't reference products table for now
  quantity: item.quantity,
  price: item.price,
  product_name: item.name, // Store product name directly
})),
```

### 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è OrderService (`/services/orders.ts`)

- –û–Ω–æ–≤–ª–µ–Ω–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å `CreateOrderData` –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ `product_id: string | null`
- –°–ø—Ä–æ—â–µ–Ω–æ –∑–∞–ø–∏—Ç–∏ –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (–≤–∏–¥–∞–ª–µ–Ω–æ JOIN –∑ `products`)
- –û–Ω–æ–≤–ª–µ–Ω–æ –≤—Å—ñ –º–µ—Ç–æ–¥–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –±–µ–∑ –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ —Ç–∞–±–ª–∏—Ü—é –ø—Ä–æ–¥—É–∫—Ç—ñ–≤

### 4. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

- –°—Ç–≤–æ—Ä–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ API
- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å –≤ Supabase
- –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ —Ä–æ–±–æ—Ç—É –≤—Å—ñ—Ö endpoint'—ñ–≤

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –¢–µ—Å—Ç API endpoint:

```bash
node test-order-api.js
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
‚úÖ Order API test successful!
Response: {
  success: true,
  orderId: 'd75d5692-715b-4f95-9344-dda74d181b18',
  message: '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ',
  estimatedDelivery: '1-2 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ'
}
```

### –¢–µ—Å—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Supabase:

```bash
npm run test:supabase
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
‚úÖ Database connected successfully!
‚úÖ Products table accessible. Found 0 products.
‚úÖ Orders table accessible. Found 2 orders.
üéâ Supabase integration test completed successfully!
```

## üìä –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö

### –¢–∞–±–ª–∏—Ü—è `orders`:

- ‚úÖ `id` - UUID (–ø–µ—Ä–≤–∏–Ω–Ω–∏–π –∫–ª—é—á)
- ‚úÖ `customer_name` - –Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞
- ‚úÖ `customer_email` - Email –∫–ª—ñ—î–Ω—Ç–∞
- ‚úÖ `customer_phone` - –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª—ñ—î–Ω—Ç–∞
- ‚úÖ `city` - –ú—ñ—Å—Ç–æ
- ‚úÖ `branch` - –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è
- ‚úÖ `payment_method` - –°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏
- ‚úÖ `total_amount` - –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞
- ‚úÖ `status` - –°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
- ‚úÖ `created_at` - –î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

### –¢–∞–±–ª–∏—Ü—è `order_items`:

- ‚úÖ `id` - UUID (–ø–µ—Ä–≤–∏–Ω–Ω–∏–π –∫–ª—é—á)
- ‚úÖ `order_id` - ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–∑–≤'—è–∑–æ–∫)
- ‚úÖ `product_id` - NULL (–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è)
- ‚úÖ `quantity` - –ö—ñ–ª—å–∫—ñ—Å—Ç—å
- ‚úÖ `price` - –¶—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é
- ‚úÖ `created_at` - –î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

### –î–ª—è –ø–æ–≤–Ω–æ—ó —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏:

1. **–ú—ñ–≥—Ä—É–≤–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏** –≤ —Ç–∞–±–ª–∏—Ü—é `products`
2. **–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏**
3. **–û–Ω–æ–≤–∏—Ç–∏ `product_id`** –≤ `order_items` –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ñ –ø—Ä–æ–¥—É–∫—Ç–∏

### –ö–æ–º–∞–Ω–¥–∏ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:

```bash
# –í—ñ–¥–∫–ª—é—á–∏—Ç–∏ RLS (—Ç–∏–º—á–∞—Å–æ–≤–æ)
npm run disable:rls

# –ú—ñ–≥—Ä—É–≤–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏
npm run migrate

# –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
npm run test:supabase

# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä
npm run dev
```

## üîß –î–æ—Å—Ç—É–ø–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏

- `npm run test:supabase` - –¢–µ—Å—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Supabase
- `npm run migrate` - –ú—ñ–≥—Ä–∞—Ü—ñ—è –ø—Ä–æ–¥—É–∫—Ç—ñ–≤
- `npm run disable:rls` - –í—ñ–¥–∫–ª—é—á–∏—Ç–∏ RLS (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)
- `npm run fix:rls` - –í–∏–ø—Ä–∞–≤–∏—Ç–∏ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏
- `npm run dev` - –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Ä–æ–∑—Ä–æ–±–∫–∏

## ‚úÖ –°—Ç–∞—Ç—É—Å

- ‚úÖ API endpoint –ø—Ä–∞—Ü—é—î
- ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ Supabase
- ‚úÖ –ü–æ–º–∏–ª–∫–∞ 500 –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞
- ‚úÖ –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—î
- ‚è≥ –ü–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç—ñ–≤

---

**–î–∞—Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**: 5 —Å—ñ—á–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ
